VERSION 0.6

FROM registry.fly.io/defn:dev-tower

platform:
    RUN echo '{ "language": "python", "app": "poetry run python -m main" }' > cdktf.json
    COPY pyproject.toml poetry.lock .
    RUN md5sum pyproject.toml poetry.lock
    RUN ~/bin/e poetry install

update:
    COPY pyproject.toml poetry.lock .
    RUN ~/bin/e poetry update
    SAVE ARTIFACT poetry.lock AS LOCAL poetry.lock

POETRY_UPDATE:
    COMMAND
    COPY pyproject.toml poetry.lock .
    RUN --no-cache ~/bin/e poetry update
    SAVE ARTIFACT poetry.lock AS LOCAL poetry.lock
    SAVE ARTIFACT pyproject.toml AS LOCAL pyproject.toml

PROJECT_UPDATE:
    COMMAND
    SAVE ARTIFACT cdktf.json AS LOCAL cdktf.json
    SAVE ARTIFACT poetry.lock AS LOCAL poetry.lock
    SAVE ARTIFACT pyproject.toml AS LOCAL pyproject.toml

CDKTF_SYNTH:
    COMMAND
    COPY main.py .
    RUN ~/bin/e poetry run python -m main
    SAVE ARTIFACT cdktf.out AS LOCAL cdktf.out

TERRAFORM_INIT:
    COMMAND
    ARG stack
    COPY cdktf.out/stacks/${stack}/cdk.tf.json .
    RUN ~/bin/e terraform init
    SAVE ARTIFACT .terraform.lock.hcl AS LOCAL cdktf.out/stacks/${stack}/.terraform.lock.hcl

TERRAFORM_PLAN:
    COMMAND
    ARG stack
    COPY cdktf.out/stacks/${stack}/cdk.tf.json .
    COPY --if-exists cdktf.out/stacks/${stack}/terraform.tfstate .
    RUN --no-cache --secret DIGITALOCEAN_TOKEN ~/bin/e terraform plan -out=.plan
    SAVE ARTIFACT .plan AS LOCAL cdktf.out/stacks/${stack}/.plan

TERRAFORM_APPLY:
    COMMAND
    ARG stack
    COPY cdktf.out/stacks/${stack}/.plan .
    COPY --if-exists cdktf.out/stacks/${stack}/terraform.tfstate .
    RUN --no-cache --secret DIGITALOCEAN_TOKEN --push ~/bin/e terraform apply .plan
    RUN --no-cache --secret DIGITALOCEAN_TOKEN --push ls -ltrhd terraform.tfstate
    SAVE ARTIFACT .plan AS LOCAL cdktf.out/stacks/${stack}/.meh
    #SAVE ARTIFACT terraform.tfstate AS LOCAL cdktf.out/stacks/${stack}/terraform.tfstate
