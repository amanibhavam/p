VERSION --parallel-load 0.6

IMPORT ../lib AS lib

FROM lib+platform

ARG stack

venv:
    RUN tar cvfz venv.tar.gz "$(~/bin/e poetry env info -p)"
    SAVE ARTIFACT venv.tar.gz AS LOCAL venv.tar.gz

update:
    FROM lib+platform
    SAVE ARTIFACT cdktf.json AS LOCAL cdktf.json
    SAVE ARTIFACT poetry.lock AS LOCAL poetry.lock
    SAVE ARTIFACT pyproject.toml AS LOCAL pyproject.toml

synth:
    DO lib+CDKTF_SYNTH

init:
    DO lib+TERRAFORM_INIT --stack=${stack}

plan:
    FROM +init --stack=${stack}
    DO lib+TERRAFORM_PLAN --stack=${stack}

apply:
    FROM +init --stack=${stack}
    DO lib+TERRAFORM_APPLY --stack=${stack}
