VERSION --parallel-load 0.6

IMPORT ../lib AS lib

FROM lib+platform

ARG stack

venv:
    RUN tar cvfz venv.tar.gz "$(~/bin/e poetry env info -p)"
    SAVE ARTIFACT venv.tar.gz AS LOCAL venv.tar.gz

synth:
    COPY main.py .
    RUN ~/bin/e poetry run python -m main
    SAVE ARTIFACT cdktf.out/stacks AS LOCAL stacks
    SAVE IMAGE --push registry.fly.io/defn:test_cdktf

init:
    ARG stack
    COPY stacks/${stack} .
    RUN ~/bin/e terraform init
    SAVE IMAGE --push registry.fly.io/defn:test_init_${stack}

plan:
    FROM +init --stack=${stack}
    RUN ~/bin/e terraform plan -out=.plan
    SAVE ARTIFACT .plan AS LOCAL .plan

apply:
    FROM +init --stack=${stack}
    COPY .plan .
    RUN ~/bin/e terraform apply .plan
