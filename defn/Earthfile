VERSION --parallel-load --shell-out-anywhere --use-chmod 0.6
# --use-registry-for-with-docker

IMPORT ../lib AS lib

FROM lib+platform

ARG stack

platform:
    FROM registry.fly.io/defn:dev-tower
    RUN --secret meh echo $meh
    RUN --secret feh echo $feh
    SAVE IMAGE --push registry.fly.io/defn:p_defn_platform

update:
    DO lib+PROJECT_UPDATE

synth:
    DO lib+CDKTF_SYNTH

init:
    DO lib+TERRAFORM_INIT --stack=${stack}

plan:
    FROM +init --stack=${stack}
    DO lib+TERRAFORM_PLAN --stack=${stack}

apply:
    FROM +init --stack=${stack}
    DO lib+TERRAFORM_APPLY --stack=${stack}
